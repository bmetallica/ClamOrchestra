<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Details - ClamOrchestra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%); font-family: 'Segoe UI', sans-serif; }
        .sidebar { background: white; min-height: 100vh; box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding: 30px 0; position: fixed; left: 0; top: 0; width: 250px; z-index: 1000; }
        .sidebar-header { padding: 0 20px 30px; border-bottom: 2px solid #667eea; }
        .sidebar-header h4 { color: #667eea; font-weight: 700; margin: 0; }
        .sidebar-nav { padding: 0; margin-top: 20px; }
        .sidebar-nav a { display: flex; align-items: center; padding: 12px 20px; color: #333; text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; }
        .sidebar-nav a:hover { background: #f0f0f0; color: #667eea; border-left-color: #667eea; }
        .sidebar-nav a.active { background: #667eea; color: white; border-left-color: #667eea; }
        .sidebar-nav i { width: 20px; margin-right: 10px; }
        .main-content { margin-left: 250px; padding: 30px; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 999; margin-left: 250px; }
        .section { background: white; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .section h2 { font-size: 1.5em; font-weight: 700; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #667eea; display: flex; align-items: center; gap: 10px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .info-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 3px solid #667eea; }
        .info-card label { color: #666; font-size: 0.9em; font-weight: 600; margin-bottom: 5px; display: block; }
        .info-card p { margin: 0; font-size: 1.1em; font-weight: 500; color: #333; }
        .btn-group-custom { gap: 10px; display: flex; flex-wrap: wrap; margin-bottom: 20px; }
        .table { margin-bottom: 0; }
        .table thead { background: #f8f9fa; }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4>ü¶† ClamOrchestra</h4>
        </div>
        <nav class="sidebar-nav">
            <a href="/"><i class="bi bi-speedometer2"></i> Dashboard</a>
            <a href="/servers"><i class="bi bi-server"></i> Server</a>
            <a href="/scans"><i class="bi bi-shield-check"></i> Scans</a>
            <a href="/alerts"><i class="bi bi-exclamation-circle"></i> Alerts</a>
            <% if (user?.is_admin) { %>
                <a href="/settings"><i class="bi bi-gear"></i> Einstellungen</a>
            <% } %>
            <hr style="margin: 20px 0;">
            <a href="/logout" style="color: #dc3545;"><i class="bi bi-box-arrow-right"></i> Abmelden</a>
        </nav>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <span class="navbar-text text-white">Server-Details</span>
            <span class="navbar-text text-white ms-auto"><i class="bi bi-person"></i> <%= user?.username %></span>
        </div>
    </nav>

    <div class="main-content">
        <div style="margin-bottom: 30px;">
            <a href="/servers" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-left"></i> Zur√ºck</a>
            <h1 id="serverName" style="margin-top: 10px; color: #333;">Server-Details</h1>
        </div>

        <!-- Server Information -->
        <div class="section">
            <h2><i class="bi bi-info-circle"></i> Server-Informationen</h2>
            <div class="info-grid">
                <div class="info-card">
                    <label>Hostname</label>
                    <p id="hostname">-</p>
                </div>
                <div class="info-card">
                    <label>IP-Adresse</label>
                    <p id="ip">-</p>
                </div>
                <div class="info-card">
                    <label>SSH-Port</label>
                    <p id="sshPort">22</p>
                </div>
                <div class="info-card">
                    <label>SSH-Benutzer</label>
                    <p id="sshUser">root</p>
                </div>
                <div class="info-card">
                    <label>Status</label>
                    <p><span id="statusBadge" class="badge bg-danger">Offline</span></p>
                </div>
                <div class="info-card">
                    <label>Erstellt am</label>
                    <p id="createdDate">-</p>
                </div>
                <div class="info-card">
                    <label>Signaturen aktualisiert am</label>
                    <p id="signatureDate">-</p>
                </div>
            </div>
        </div>

        <!-- ClamAV Management -->
        <div class="row">
            <div class="col-md-6">
                <div class="section">
                    <h2><i class="bi bi-shield-check"></i> ClamAV-Management</h2>
                    <div id="clamavStatus" style="margin-bottom: 20px;"></div>
                    <div class="btn-group-custom">
                        <button class="btn btn-success" onclick="installClamav()">
                            <i class="bi bi-download"></i> Installieren
                        </button>
                        <button class="btn btn-info" onclick="updateSignatures()">
                            <i class="bi bi-arrow-repeat"></i> Signaturen aktualisieren
                        </button>
                    </div>
                </div>
            </div>

            <!-- SSH Verbindung -->
            <div class="col-md-6">
                <div class="section">
                    <h2><i class="bi bi-terminal"></i> SSH-Verbindung</h2>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 0.9em; color: #666;">Verbindungsstatus:</p>
                        <p id="connectionStatus" style="margin: 5px 0 0; font-weight: 600; color: #dc3545;">Nicht gepr√ºft</p>
                    </div>
                    <button class="btn btn-secondary w-100" onclick="testConnection()">
                        <i class="bi bi-wifi"></i> Verbindung testen
                    </button>
                </div>
            </div>
        </div>

        <!-- LogFetcher Einstellungen -->
        <div class="section">
            <h2><i class="bi bi-clock-history"></i> LogFetcher-Einstellungen</h2>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">Konfigurieren Sie, wann und wie oft die Scan-Protokolle und ClamAV-Einstellungen von diesem Server abgerufen werden.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="logFetchFrequency" class="form-label">Abruf-H√§ufigkeit</label>
                        <select id="logFetchFrequency" class="form-select" onchange="updateLogFetcherUI()">
                            <option value="hourly">St√ºndlich</option>
                            <option value="daily">T√§glich</option>
                            <option value="weekly">W√∂chentlich</option>
                        </select>
                        <small class="text-muted">Wie oft sollen die Logs abgerufen werden?</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="logFetchEnabled" class="form-check-label">
                            <input type="checkbox" id="logFetchEnabled" class="form-check-input" checked>
                            LogFetcher aktiviert
                        </label>
                        <small class="text-muted d-block">Aktivieren/Deaktivieren dieses Servers</small>
                    </div>
                </div>
            </div>
            
            <div id="dailyHourGroup" class="row" style="display: none;">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="logFetchDailyHour" class="form-label">T√§gliche Uhrzeit</label>
                        <select id="logFetchDailyHour" class="form-select">
                            <option value="0">00:00 Uhr</option>
                            <option value="1">01:00 Uhr</option>
                            <option value="2">02:00 Uhr</option>
                            <option value="3">03:00 Uhr</option>
                            <option value="4">04:00 Uhr</option>
                            <option value="5">05:00 Uhr</option>
                            <option value="6">06:00 Uhr</option>
                            <option value="7">07:00 Uhr</option>
                            <option value="8">08:00 Uhr</option>
                            <option value="9">09:00 Uhr</option>
                            <option value="10">10:00 Uhr</option>
                            <option value="11">11:00 Uhr</option>
                            <option value="12">12:00 Uhr</option>
                            <option value="13">13:00 Uhr</option>
                            <option value="14">14:00 Uhr</option>
                            <option value="15">15:00 Uhr</option>
                            <option value="16">16:00 Uhr</option>
                            <option value="17">17:00 Uhr</option>
                            <option value="18">18:00 Uhr</option>
                            <option value="19">19:00 Uhr</option>
                            <option value="20">20:00 Uhr</option>
                            <option value="21">21:00 Uhr</option>
                            <option value="22">22:00 Uhr</option>
                            <option value="23">23:00 Uhr</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="weeklyGroup" class="row" style="display: none;">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="logFetchWeeklyDay" class="form-label">Wochentag</label>
                        <select id="logFetchWeeklyDay" class="form-select">
                            <option value="0">Sonntag</option>
                            <option value="1">Montag</option>
                            <option value="2">Dienstag</option>
                            <option value="3">Mittwoch</option>
                            <option value="4">Donnerstag</option>
                            <option value="5">Freitag</option>
                            <option value="6">Samstag</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="logFetchWeeklyHour" class="form-label">Uhrzeit</label>
                        <select id="logFetchWeeklyHour" class="form-select">
                            <option value="0">00:00 Uhr</option>
                            <option value="1">01:00 Uhr</option>
                            <option value="2">02:00 Uhr</option>
                            <option value="3">03:00 Uhr</option>
                            <option value="4">04:00 Uhr</option>
                            <option value="5">05:00 Uhr</option>
                            <option value="6">06:00 Uhr</option>
                            <option value="7">07:00 Uhr</option>
                            <option value="8">08:00 Uhr</option>
                            <option value="9">09:00 Uhr</option>
                            <option value="10">10:00 Uhr</option>
                            <option value="11">11:00 Uhr</option>
                            <option value="12">12:00 Uhr</option>
                            <option value="13">13:00 Uhr</option>
                            <option value="14">14:00 Uhr</option>
                            <option value="15">15:00 Uhr</option>
                            <option value="16">16:00 Uhr</option>
                            <option value="17">17:00 Uhr</option>
                            <option value="18">18:00 Uhr</option>
                            <option value="19">19:00 Uhr</option>
                            <option value="20">20:00 Uhr</option>
                            <option value="21">21:00 Uhr</option>
                            <option value="22">22:00 Uhr</option>
                            <option value="23">23:00 Uhr</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="saveLogFetcherSettings()">
                <i class="bi bi-check-circle"></i> Einstellungen speichern
            </button>
            <button class="btn btn-primary ms-2" onclick="fetchLogsNowButton()">
                <i class="bi bi-download"></i> Daten jetzt abrufen
            </button>
        </div>

        <!-- Scan Jobs (merged with detected cronjobs) -->
        <div class="section">
            <h2><i class="bi bi-calendar-check"></i> Scan-Jobs</h2>
            
            <!-- Tabs -->
            <ul class="nav nav-tabs" id="scanJobsTabs" role="tablist" style="margin-bottom: 20px;">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="activeJobsTab" data-bs-toggle="tab" data-bs-target="#activeJobs" type="button">Aktive Jobs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="newJobTab" data-bs-toggle="tab" data-bs-target="#newJob" type="button">Neuer Job</button>
                </li>
                <li class="nav-item ms-auto" role="presentation">
                    <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogsNowButton()" title="Erkannte Jobs vom Server abrufen">
                        <i class="bi bi-download"></i> Daten jetzt abrufen
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="scanJobsContent">
                <!-- Aktive Jobs Tab -->
                <div class="tab-pane fade show active" id="activeJobs" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Typ</th>
                                    <th>Zeitplan</th>
                                    <th>Status</th>
                                    <th>Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="scanJobsList">
                                <tr><td colspan="5" class="text-center text-muted">L√§dt...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Neuer Job Tab -->
                <div class="tab-pane fade" id="newJob" role="tabpanel">
                    <form id="addScanForm" style="max-width: 600px;">
                        <div class="mb-3">
                            <label class="form-label">Job-Name *</label>
                            <input type="text" class="form-control" name="name" placeholder="z.B. T√§glicher Scan" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Scan-Typ *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="scan_type" id="scanTypeQuick" value="quick" required checked>
                                <label class="btn btn-outline-secondary" for="scanTypeQuick">Quick Scan</label>
                                
                                <input type="radio" class="btn-check" name="scan_type" id="scanTypeFull" value="full" required>
                                <label class="btn btn-outline-secondary" for="scanTypeFull">Full Scan</label>
                                
                                <input type="radio" class="btn-check" name="scan_type" id="scanTypeCustom" value="custom" required>
                                <label class="btn btn-outline-secondary" for="scanTypeCustom">Custom</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Pfade zu scannen *</label>
                            <input type="text" class="form-control" name="paths" placeholder="/home, /var, /opt (komma-getrennt)" value="/home,/var,/opt" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Zeitplan *</label>
                            <select class="form-control" id="scheduleFrequency" onchange="updateScheduleUI()" required>
                                <option value="">-- W√§hlen Sie --</option>
                                <option value="hourly">St√ºndlich</option>
                                <option value="daily">T√§glich</option>
                                <option value="weekly">W√∂chentlich</option>
                                <option value="custom">Benutzerdefiniert (Cron)</option>
                            </select>
                        </div>

                        <!-- Daily Options -->
                        <div id="dailyOptionsGroup" style="display: none;" class="mb-3">
                            <label class="form-label">Uhrzeit (Stunde) *</label>
                            <select class="form-control" id="dailyHour">
                                <option value="">-- W√§hlen Sie --</option>
                                <% for(let i = 0; i < 24; i++) { %>
                                    <option value="<%= i %>"><%= String(i).padStart(2, '0') %>:00 Uhr</option>
                                <% } %>
                            </select>
                        </div>

                        <!-- Weekly Options -->
                        <div id="weeklyOptionsGroup" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Wochentag *</label>
                                    <select class="form-control" id="weeklyDay">
                                        <option value="">-- W√§hlen Sie --</option>
                                        <option value="0">Sonntag</option>
                                        <option value="1">Montag</option>
                                        <option value="2">Dienstag</option>
                                        <option value="3">Mittwoch</option>
                                        <option value="4">Donnerstag</option>
                                        <option value="5">Freitag</option>
                                        <option value="6">Samstag</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Uhrzeit (Stunde) *</label>
                                    <select class="form-control" id="weeklyHour">
                                        <option value="">-- W√§hlen Sie --</option>
                                        <% for(let i = 0; i < 24; i++) { %>
                                            <option value="<%= i %>"><%= String(i).padStart(2, '0') %>:00 Uhr</option>
                                        <% } %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Cron Options -->
                        <div id="customCronGroup" style="display: none;" class="mb-3">
                            <label class="form-label">Cron-Ausdruck *</label>
                            <input type="text" class="form-control" id="customCronExpression" placeholder="0 2 * * * (t√§glich um 2 Uhr)">
                            <small class="text-muted d-block mt-2">
                                Format: Minute Stunde Tag Monat Wochentag<br>
                                Beispiele:<br>
                                ‚Ä¢ <code>0 2 * * *</code> ‚Üí T√§glich um 2:00 Uhr<br>
                                ‚Ä¢ <code>0 2 * * 0</code> ‚Üí Sonntags um 2:00 Uhr<br>
                                ‚Ä¢ <code>0 */6 * * *</code> ‚Üí Alle 6 Stunden
                            </small>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="createScanJob()">
                                <i class="bi bi-plus-circle"></i> Job erstellen
                            </button>
                            <button type="reset" class="btn btn-secondary">Zur√ºcksetzen</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Scan Results -->
        <div class="section">
            <h2><i class="bi bi-graph-up"></i> Scan-Ergebnisse</h2>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Status</th>
                            <th>Dateien gescannt</th>
                            <th>Bedrohungen</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="scanResultsList">
                        <tr><td colspan="5" class="text-center text-muted">L√§dt...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Detections -->
        <div class="section">
            <h2><i class="bi bi-exclamation-triangle"></i> Erkannte Bedrohungen</h2>
            <div id="detectionsList"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const serverId = '<%= serverId %>';

        async function loadServerData() {
            try {
                const servers = await fetch('/api/servers').then(r => r.json());
                const server = servers.servers.find(s => s.id == serverId);
                
                if (!server) {
                    document.body.innerHTML = '<div class="alert alert-danger m-4">Server nicht gefunden</div>';
                    return;
                }
                
                document.getElementById('serverName').textContent = server.name;
                document.getElementById('hostname').textContent = server.hostname;
                document.getElementById('ip').textContent = server.ip_address || '-';
                document.getElementById('sshPort').textContent = server.port;
                document.getElementById('sshUser').textContent = server.ssh_user || 'root';
                document.getElementById('statusBadge').className = `badge bg-${server.status === 'online' ? 'success' : 'danger'}`;
                document.getElementById('statusBadge').textContent = server.status === 'online' ? 'Online' : 'Offline';
                document.getElementById('createdDate').textContent = new Date(server.created_at).toLocaleString('de-DE');
                
                // Display signature update date
                if (server.signature_updated_at) {
                    document.getElementById('signatureDate').textContent = new Date(server.signature_updated_at).toLocaleString('de-DE');
                } else {
                    document.getElementById('signatureDate').textContent = 'Noch nicht aktualisiert';
                }
                
                await loadClamavStatus();
                await loadScanJobs();
                await loadScanResults();
                await loadDetections();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function loadClamavStatus() {
            try {
                const res = await fetch(`/api/clamav/config/${serverId}`);
                const { config } = await res.json();
                
                const statusDiv = document.getElementById('clamavStatus');
                if (!config || !config.is_installed) {
                    statusDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è ClamAV ist nicht installiert</div>';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ ClamAV ${config.version || 'installiert'}</div>`;
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function loadScanJobs() {
            try {
                // Load ONLY detected_cronjobs - this is the single source of truth (what's really on the server)
                const resDetected = await fetch(`/api/detected-cronjobs/${serverId}`);
                const { cronjobs } = await resDetected.json();
                
                const tbody = document.getElementById('scanJobsList');
                
                if (!cronjobs || cronjobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Keine Scan-Jobs vorhanden</td></tr>';
                    return;
                }
                
                tbody.innerHTML = cronjobs.map(job => {
                    // Jobs with scan_job_id = created by the app
                    // Jobs without scan_job_id = manually detected on the server
                    const isDetected = !job.scan_job_id;
                    const jobName = job.command.substring(0, 60);
                    
                    return `
                        <tr>
                            <td><strong>${jobName}</strong></td>
                            <td>${isDetected ? 'erkannt' : 'App'}</td>
                            <td><code style="font-size: 0.85em;">${escapeHtml(job.cron_expression)}</code></td>
                            <td><span class="badge bg-success">Aktiv</span></td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteJob(${job.id}, 'detected')" title="L√∂schen">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Fehler beim Laden der Scan-Jobs:', error);
                document.getElementById('scanJobsList').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Fehler beim Laden</td></tr>';
            }
        }

        async function loadScanResults() {
            try {
                const res = await fetch(`/api/scans/results/${serverId}`);
                const { results } = await res.json();
                
                const tbody = document.getElementById('scanResultsList');
                if (results.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Keine Scan-Ergebnisse vorhanden</td></tr>';
                    return;
                }
                
                tbody.innerHTML = results.slice(0, 10).map(result => `
                    <tr>
                        <td>${new Date(result.start_time).toLocaleString('de-DE')}</td>
                        <td><span class="badge bg-${result.status === 'completed' ? 'success' : 'info'}">${result.status}</span></td>
                        <td>${result.files_scanned}</td>
                        <td><strong class="text-danger">${result.threats_found}</strong></td>
                        <td><a href="#" class="btn btn-sm btn-primary" onclick="showScanDetails(${result.id})">Details</a></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function loadDetections() {
            try {
                const detections = await fetch('/api/detections').then(r => r.json());
                const serverDetections = detections.detections.filter(d => d.server_id == serverId);
                
                const list = document.getElementById('detectionsList');
                if (serverDetections.length === 0) {
                    list.innerHTML = '<p class="text-success">‚úÖ Keine Bedrohungen gefunden</p>';
                    return;
                }
                
                list.innerHTML = serverDetections.slice(0, 10).map(d => {
                    const isResolved = d.resolved_at !== null && d.resolved_at !== undefined;
                    const bgColor = isResolved ? '#d4edda' : '#fff3cd';
                    const borderColor = isResolved ? '#28a745' : '#ffc107';
                    const textColor = isResolved ? '#155724' : '#856404';
                    const statusIcon = isResolved ? '‚úÖ' : '‚ö†Ô∏è';
                    const statusText = isResolved ? 'Behoben' : 'Aktiv';
                    const resolvedDate = isResolved ? `<br><strong>Behoben am:</strong> ${new Date(d.resolved_at).toLocaleString('de-DE')}` : '';
                    
                    return `
                        <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <h6 style="margin: 0; color: ${textColor};"><strong>${statusIcon} ${d.threat_name}</strong></h6>
                                <span style="background: ${borderColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: bold;">${statusText}</span>
                            </div>
                            <p style="margin: 0; font-size: 0.9em; color: ${textColor};">
                                <strong>Pfad:</strong> ${d.file_path}<br>
                                <strong>Erkannt am:</strong> ${new Date(d.created_at).toLocaleString('de-DE')}${resolvedDate}
                            </p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function installClamav() {
            if (!confirm('ClamAV auf diesem Server installieren?')) return;
            try {
                await fetch(`/api/clamav/install/${serverId}`, { method: 'POST' });
                alert('Installation gestartet');
                await loadClamavStatus();
            } catch (error) {
                alert('Fehler bei Installation');
            }
        }

        async function updateSignatures() {
            try {
                await fetch(`/api/clamav/update-signatures/${serverId}`, { method: 'POST' });
                alert('Signaturen-Update gestartet');
            } catch (error) {
                alert('Fehler beim Update');
            }
        }

        async function createScanJob() {
            const form = document.getElementById('addScanForm');
            const frequency = document.getElementById('scheduleFrequency').value;
            
            if (!frequency) {
                alert('‚ùå Bitte w√§hlen Sie einen Zeitplan');
                return;
            }
            
            let cron_expression = '';
            
            if (frequency === 'hourly') {
                cron_expression = '0 * * * *'; // Jede Stunde zur vollen Stunde
            } else if (frequency === 'daily') {
                const hour = document.getElementById('dailyHour').value;
                if (!hour) {
                    alert('‚ùå Bitte w√§hlen Sie eine Uhrzeit');
                    return;
                }
                cron_expression = `0 ${hour} * * *`;
            } else if (frequency === 'weekly') {
                const day = document.getElementById('weeklyDay').value;
                const hour = document.getElementById('weeklyHour').value;
                if (!day || !hour) {
                    alert('‚ùå Bitte w√§hlen Sie Wochentag und Uhrzeit');
                    return;
                }
                cron_expression = `0 ${hour} * * ${day}`;
            } else if (frequency === 'custom') {
                cron_expression = document.getElementById('customCronExpression').value.trim();
                if (!cron_expression) {
                    alert('‚ùå Bitte geben Sie einen Cron-Ausdruck ein');
                    return;
                }
            }
            
            const data = {
                server_id: parseInt(serverId),
                name: form.name.value,
                scan_type: document.querySelector('input[name="scan_type"]:checked').value,
                paths: form.paths.value.split(',').map(p => p.trim()),
                cron_expression: cron_expression
            };
            
            try {
                const res = await fetch('/api/scans/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    form.reset();
                    document.getElementById('scheduleFrequency').value = '';
                    updateScheduleUI();
                    alert('‚úÖ Scan-Job erfolgreich erstellt!');
                    document.getElementById('activeJobsTab').click();
                    // Auto-fetch logs to immediately show the new job in the UI
                    await fetchLogsNow();
                    await loadScanJobs();
                } else {
                    const error = await res.json();
                    alert('‚ùå Fehler: ' + error.error);
                }
            } catch (error) {
                alert('‚ùå Fehler beim Erstellen: ' + error.message);
            }
        }

        function updateScheduleUI() {
            const frequency = document.getElementById('scheduleFrequency').value;
            document.getElementById('dailyOptionsGroup').style.display = frequency === 'daily' ? 'block' : 'none';
            document.getElementById('weeklyOptionsGroup').style.display = frequency === 'weekly' ? 'block' : 'none';
            document.getElementById('customCronGroup').style.display = frequency === 'custom' ? 'block' : 'none';
        }

        async function deleteJob(jobId, jobType) {
            if (!confirm('Job wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                return;
            }

            try {
                // Always use detected_cronjobs endpoint (single source of truth)
                const endpoint = `/api/detected-cronjobs/${jobId}`;

                const res = await fetch(endpoint, { method: 'DELETE' });
                const result = await res.json();

                if (res.ok) {
                    alert('‚úÖ Job erfolgreich gel√∂scht!');
                    await loadScanJobs();
                } else {
                    alert('‚ùå Fehler: ' + (result.error || 'Unbekannter Fehler'));
                }
            } catch (error) {
                alert('‚ùå Fehler beim L√∂schen: ' + error.message);
            }
        }

        function testConnection() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verbindung wird getestet...';
            
            fetch(`/api/servers/${serverId}/test-connection`, { method: 'POST' })
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success') {
                        alert('‚úÖ Verbindung erfolgreich! Server ist online.');
                        document.getElementById('connectionStatus').textContent = '‚úÖ Verbunden';
                        document.getElementById('connectionStatus').className = 'text-success';
                        document.getElementById('statusBadge').className = 'badge bg-success';
                        document.getElementById('statusBadge').textContent = 'Online';
                        loadServerData(); // Aktualisiere alle Daten
                    } else {
                        alert('‚ùå Verbindung fehlgeschlagen: ' + res.message);
                        document.getElementById('connectionStatus').textContent = '‚ùå Fehler: ' + res.message;
                        document.getElementById('connectionStatus').className = 'text-danger';
                    }
                })
                .catch(error => {
                    alert('‚ùå Fehler: ' + error.message);
                    document.getElementById('connectionStatus').textContent = '‚ùå Fehler';
                    document.getElementById('connectionStatus').className = 'text-danger';
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-wifi"></i> Verbindung testen';
                });
        }

        loadServerData();
        
        // LogFetcher Settings
        async function loadLogFetcherSettings() {
            try {
                const res = await fetch(`/api/log-fetch-schedule/${serverId}`);
                const data = await res.json();
                if (data.schedule) {
                    document.getElementById('logFetchFrequency').value = data.schedule.frequency || 'hourly';
                    document.getElementById('logFetchDailyHour').value = data.schedule.daily_hour || 0;
                    document.getElementById('logFetchWeeklyDay').value = data.schedule.weekly_day || 0;
                    document.getElementById('logFetchWeeklyHour').value = data.schedule.weekly_hour || 0;
                    document.getElementById('logFetchEnabled').checked = data.schedule.enabled !== false;
                    updateLogFetcherUI();
                }
            } catch (error) {
                console.error('Error loading log fetcher settings:', error);
            }
        }
        
        function updateLogFetcherUI() {
            const frequency = document.getElementById('logFetchFrequency').value;
            document.getElementById('dailyHourGroup').style.display = frequency === 'daily' ? 'block' : 'none';
            document.getElementById('weeklyGroup').style.display = frequency === 'weekly' ? 'block' : 'none';
        }
        
        async function saveLogFetcherSettings() {
            const data = {
                frequency: document.getElementById('logFetchFrequency').value,
                daily_hour: parseInt(document.getElementById('logFetchDailyHour').value),
                weekly_day: parseInt(document.getElementById('logFetchWeeklyDay').value),
                weekly_hour: parseInt(document.getElementById('logFetchWeeklyHour').value),
                enabled: document.getElementById('logFetchEnabled').checked
            };
            
            try {
                const res = await fetch(`/api/log-fetch-schedule/${serverId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                alert('‚úÖ LogFetcher-Einstellungen gespeichert!');
                console.log('LogFetcher settings updated:', result);
            } catch (error) {
                alert('‚ùå Fehler beim Speichern: ' + error.message);
            }
        }
        
        async function showScanDetails(scanId) {
            try {
                const res = await fetch(`/api/scans/${scanId}`);
                if (!res.ok) throw new Error('Scan nicht gefunden');
                
                const scan = await res.json();
                const modal = new bootstrap.Modal(document.getElementById('scanDetailsModal'));
                
                document.getElementById('scanDetailsContent').innerHTML = `
                    <div class="mb-3">
                        <h5>Scan-Informationen</h5>
                        <dl class="row">
                            <dt class="col-sm-4">Server:</dt>
                            <dd class="col-sm-8">${scan.server_name}</dd>
                            <dt class="col-sm-4">Startzeit:</dt>
                            <dd class="col-sm-8">${new Date(scan.start_time).toLocaleString('de-DE')}</dd>
                            <dt class="col-sm-4">Endzeit:</dt>
                            <dd class="col-sm-8">${new Date(scan.end_time).toLocaleString('de-DE')}</dd>
                            <dt class="col-sm-4">Dateien gescannt:</dt>
                            <dd class="col-sm-8">${scan.files_scanned}</dd>
                            <dt class="col-sm-4">Bedrohungen gefunden:</dt>
                            <dd class="col-sm-8"><strong class="text-danger">${scan.threats_found}</strong></dd>
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8"><span class="badge bg-${scan.status === 'completed' ? 'success' : 'info'}">${scan.status}</span></dd>
                        </dl>
                    </div>
                    <div class="mb-3">
                        <h5>Scan-Log</h5>
                        <div style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 0.85em;">
                            ${scan.raw_output ? scan.raw_output : '<em class="text-muted">Kein Log verf√ºgbar</em>'}
                        </div>
                    </div>
                `;
                
                modal.show();
            } catch (error) {
                alert('‚ùå Fehler beim Laden der Details: ' + error.message);
            }
        }
        
        async function fetchLogsNow(showMessage = true) {
            try {
                const res = await fetch(`/api/log-fetch/${serverId}/fetch-now`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await res.json();
                
                if (res.ok) {
                    if (showMessage) {
                        alert('‚úÖ ' + result.message);
                    }
                    console.log('Log fetch initiated:', result);
                    // Reload scan jobs and ClamAV status after fetching
                    await loadScanJobs();
                    await loadClamavStatus();
                } else {
                    if (showMessage) {
                        alert('‚ùå Fehler: ' + result.error);
                    }
                }
            } catch (error) {
                if (showMessage) {
                    alert('‚ùå Fehler beim Abrufen: ' + error.message);
                }
            }
        }
        
        function fetchLogsNowButton() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Daten werden abgerufen...';
            
            fetchLogsNow(true).finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-download"></i> Daten jetzt abrufen';
            });
        }
        
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.insertAdjacentElement('afterbegin', alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        loadServerData();
        loadLogFetcherSettings();
    </script>

    <!-- Scan Details Modal -->
    <div class="modal fade" id="scanDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Scan-Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="scanDetailsContent">L√§dt...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
